/**
 * Search Page - Futuristic Search Experience
 */

import { useState, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { Search, X, TrendingUp, Clock, Music, Mic2, Disc3, ListMusic, Play } from 'lucide-react'
import { Link } from 'react-router-dom'
import { deezerService } from '../services/deezer.service'
import { usePlayer } from '../contexts/PlayerContext'
import MusicCard from '../components/MusicCard'
import { webAnimations } from '../../../shared/theme/animations'
import styles from './SearchPage.module.css'

// Trending searches
const trendingSearches = [
  'Chill Vibes', 'Workout Mix', 'Jazz Essentials', 'Electronic Dreams',
  'Indie Rock', 'Classical Piano', 'Hip Hop Beats', 'Summer Hits'
]

type FilterType = 'all' | 'tracks' | 'albums' | 'artists' | 'playlists'

interface SearchResults {
  tracks: any[]
  albums: any[]
  artists: any[]
}

function SearchPage() {
  const [searchQuery, setSearchQuery] = useState('')
  const [activeFilter, setActiveFilter] = useState<FilterType>('all')
  const [searchResults, setSearchResults] = useState<any>(null)
  const [isSearching, setIsSearching] = useState(false)
  const [recentSearches, setRecentSearches] = useState<string[]>(mockRecentSearches)

  // Debounced search
  useEffect(() => {
    if (searchQuery.length < 2) {
      setSearchResults(null)
      return
    }

    setIsSearching(true)
    const timer = setTimeout(() => {
      // TODO: Replace with actual API call
      setSearchResults(mockSearchResults)
      setIsSearching(false)
    }, 500)

    return () => clearTimeout(timer)
  }, [searchQuery])

  const handleSearch = (query: string) => {
    setSearchQuery(query)
    if (query && !recentSearches.includes(query)) {
      setRecentSearches([query, ...recentSearches.slice(0, 9)])
    }
  }

  const clearSearch = () => {
    setSearchQuery('')
    setSearchResults(null)
  }

  const filters: { type: FilterType; label: string; icon: any }[] = [
    { type: 'all', label: 'All', icon: Search },
    { type: 'tracks', label: 'Tracks', icon: Music },
    { type: 'albums', label: 'Albums', icon: Disc3 },
    { type: 'artists', label: 'Artists', icon: Mic2 },
    { type: 'playlists', label: 'Playlists', icon: ListMusic }
  ]

  return (
    <div className={styles.container}>
      {/* Search Header */}
      <motion.div 
        className={styles.searchHeader}
        {...webAnimations.fadeInUp}
      >
        <h1 className={styles.title}>
          <Search className={styles.titleIcon} />
          Search
        </h1>
        
        {/* Search Bar */}
        <div className={styles.searchBarContainer}>
          <motion.div 
            className={styles.searchBar}
            whileFocus={{ scale: 1.02 }}
          >
            <Search className={styles.searchIcon} />
            <input
              type="text"
              placeholder="Search for tracks, albums, artists, or playlists..."
              value={searchQuery}
              onChange={(e) => handleSearch(e.target.value)}
              className={styles.searchInput}
              autoFocus
            />
            <AnimatePresence>
              {searchQuery && (
                <motion.button
                  initial={{ scale: 0, opacity: 0 }}
                  animate={{ scale: 1, opacity: 1 }}
                  exit={{ scale: 0, opacity: 0 }}
                  className={styles.clearButton}
                  onClick={clearSearch}
                >
                  <X size={18} />
                </motion.button>
              )}
            </AnimatePresence>
          </motion.div>

          {/* Filter Pills */}
          <motion.div 
            className={styles.filters}
            {...webAnimations.fadeInUp}
            transition={{ delay: 0.1 }}
          >
            {filters.map((filter) => {
              const Icon = filter.icon
              return (
                <motion.button
                  key={filter.type}
                  className={`${styles.filterPill} ${activeFilter === filter.type ? styles.active : ''}`}
                  onClick={() => setActiveFilter(filter.type)}
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }}
                >
                  <Icon size={16} />
                  {filter.label}
                </motion.button>
              )
            })}
          </motion.div>
        </div>
      </motion.div>

      {/* Content */}
      <div className={styles.content}>
        {!searchQuery && !searchResults && (
          <>
            {/* Trending Searches */}
            <motion.section 
              className={styles.section}
              {...webAnimations.fadeInUp}
              transition={{ delay: 0.2 }}
            >
              <h2 className={styles.sectionTitle}>
                <TrendingUp size={20} />
                Trending Searches
              </h2>
              <div className={styles.chipGrid}>
                {mockTrendingSearches.map((term, index) => (
                  <motion.button
                    key={term}
                    className={styles.trendingChip}
                    onClick={() => handleSearch(term)}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.3 + index * 0.05 }}
                    whileHover={{ scale: 1.05, boxShadow: '0 0 20px rgba(139, 92, 246, 0.5)' }}
                    whileTap={{ scale: 0.95 }}
                  >
                    {term}
                  </motion.button>
                ))}
              </div>
            </motion.section>

            {/* Recent Searches */}
            {recentSearches.length > 0 && (
              <motion.section 
                className={styles.section}
                {...webAnimations.fadeInUp}
                transition={{ delay: 0.4 }}
              >
                <h2 className={styles.sectionTitle}>
                  <Clock size={20} />
                  Recent Searches
                </h2>
                <div className={styles.recentList}>
                  {recentSearches.map((term, index) => (
                    <motion.button
                      key={index}
                      className={styles.recentItem}
                      onClick={() => handleSearch(term)}
                      initial={{ opacity: 0, x: -20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: 0.5 + index * 0.05 }}
                      whileHover={{ x: 5 }}
                    >
                      <Clock size={16} className={styles.recentIcon} />
                      {term}
                      <button
                        className={styles.removeRecent}
                        onClick={(e) => {
                          e.stopPropagation()
                          setRecentSearches(recentSearches.filter((_, i) => i !== index))
                        }}
                      >
                        <X size={14} />
                      </button>
                    </motion.button>
                  ))}
                </div>
              </motion.section>
            )}
          </>
        )}

        {/* Search Results */}
        {isSearching && (
          <div className={styles.loadingState}>
            <motion.div
              className={styles.loadingSpinner}
              animate={{ rotate: 360 }}
              transition={{ duration: 1, repeat: Infinity, ease: 'linear' }}
            >
              <Search size={32} />
            </motion.div>
            <p>Searching...</p>
          </div>
        )}

        {searchResults && !isSearching && (
          <motion.div
            className={styles.results}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
          >
            {/* Tracks Results */}
            {(activeFilter === 'all' || activeFilter === 'tracks') && searchResults.tracks?.length > 0 && (
              <motion.section 
                className={styles.section}
                {...webAnimations.fadeInUp}
              >
                <h2 className={styles.sectionTitle}>
                  <Music size={20} />
                  Tracks
                </h2>
                <div className={styles.tracksGrid}>
                  {searchResults.tracks.map((track: any, index: number) => (
                    <MusicCard
                      key={track.id}
                      title={track.title}
                      artist={track.artist}
                      image={track.coverArt}
                      duration={`${Math.floor(track.duration / 60)}:${(track.duration % 60).toString().padStart(2, '0')}`}
                      delay={index * 0.1}
                    />
                  ))}
                </div>
              </motion.section>
            )}

            {/* Empty State */}
            {searchResults.tracks?.length === 0 && (
              <motion.div
                className={styles.emptyState}
                {...webAnimations.fadeInUp}
              >
                <Search size={64} className={styles.emptyIcon} />
                <h3>No results found</h3>
                <p>Try searching with different keywords</p>
              </motion.div>
            )}
          </motion.div>
        )}
      </div>
    </div>
  )
}

export default SearchPage
